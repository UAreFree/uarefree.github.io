# C++ Static




<!--more--> 

static是C++中非常常见的关键字，以下总结static关键字的使用场景，即什么时候使用static。
首先说static是静态的意思，什么是静态呢？你可能会听过静态存储区，一段内存的区域，我们来看看C程序的内存分布。
{{< image src="/cpp/程序内存分布.png" caption="程序内存分布" width="45%" height="45%">}}

C程序内存地址从低到高依次为代码区、初始化的数据区（.data段）、未被初始化的数据区(.bss段)、堆和栈，静态存储区就位于数据区，这里的数据区主要有全局变量、static变量，而一般的变量会被放在堆或栈区，栈主要存函数中的局部变量、堆主要存new的内存。

| 内存区域       | 存储内容         | 特点                                       |
|----------------|------------------|--------------------------------------------|
| 代码区         | 程序指令         | 1. 只读<br>2. 所有线程共享                |
| 初始化数据区   | 1. 全局变量<br>2. static变量         | 1. 编译时显示赋值<br>2. 程序加载时分配内存，读取可执行文件存储的初始值 |
| 未初始化的数据区 | 1. 未初始化的全局变量<br>2. 未初始化的static变量 | 1. 程序加载时被自动初始化为零（数值类型为 0，指针类型为 NULL）<br>2. 程序加载时分配内存，但可执行文件不会存储未初始化的数据                   |
| 堆区           | 动态分配函数（如malloc、calloc或new）分配的内存 | 1. 动态分配，由程序员管理<br>2. 生存周期由程序控制，可以跨函数代码块使用 |
| 栈区           | 局部变量、函数参数、返回地址 | 1. 由编译器自动分配，遵循“先进后出”的结构<br>2. 生命周期为函数调用期间的执行周期 |

initialized data 和 uninitialized data 有什么区别？
1. 初始化状态，顾名思义，初始化区的变量会显示赋值初始化，未被初始化区的变量未被显示赋值初始化。
2. 可执行文件存储，未被初始化区变量的数据不会存储到可执行文件中，而是直接将分配的内存赋值为零。

所以static变量的生命周期就和全局变量一样是程序运行的整个生命周期，那static变量和全局变量又有什么区别呢？我们想用多个函数操作同一个变量就用全局变量不就可以了？为什么还要有static变量呢？

对于static局部变量，它和全局变量的区别是：
1. 作用域不同，局部变量限制其作用域在函数内，仅在函数内可见，外部无法访问，提高了封装性。
2. static局部变量的动态初始化在第一次执行到声明语句时初始化，而全局变量在程序启动时就初始化，避免了资源浪费，静态初始化与全局变量一致。

对于static全局变量，它就是在全局变量的基础上限制了作用域为当前文件，即使使用extern外部文件也无法使用。这可以减少同命名变量冲突，减少模块的耦合度。

在这里对static变量有了初步的认识，那我们加上类。

类static变量，顾名思义声明于某个类内的static变量，那它和普通成员变量有什么区别呢？类比上述非类的情况，类static变量的生命周期是整个程序，也就不像对象的成员变量随对象创建消亡，那么它的初始化就要在类外定义和初始化，所有对象共享一个static成员变量。
```C++
class A {
public:
    static int count; //类内声明    
}
int A::count = 0; //类外定义初始化
```

接下来是static函数，对于类外的static函数，其作用是限制其作用域为本文件内；对于类内的static成员函数，类似于类内的static成员变量，它不属于具体的对象，而是属于类本身，没有具体的this指针，不能访问非static成员变量和非static成员函数。
```C++
class A {
public:
    static int count; //类内声明   
    static void display(){ //static成员函数
        std::cout << "A::count: " << count << std::endl;
    } 
}
int A::count = 0; //类外定义初始化
int main(){
    A::display(); //直接通过类名调用
    return 0;
}
```
static成员函数的作用其实更像是提供类级别的函数，实现与类具体对象无关的通用功能。它避免了实例化对象，减少了this指针的开销。
```C++
class A {
public:
    static int count; //类内声明   
    static void display(){ //static成员函数
        std::cout << "A::count: " << count << std::endl;
    } 
    static int add(int a, int b){
        return a + b;
    }
}
int A::count = 0; //类外定义初始化
int main(){
    A::display(); //直接通过类名调用
    std::cout << A::add(1, 2) << std::endl; //实现通用功能
    return 0;
}
```
扩展，C++中有四种存储周期：
| 存储周期         | 声明周期         | 示例                             | 用法                                           |
|------------------|------------------|----------------------------------|------------------------------------------------|
| 静态 static      | 程序开始到程序结束 | 全局变量，static局部变量，类的静态成员 | 用于全局状态变量或需要跨函数的持久状态          |
| 动态 dynamic     | 显示分配到显示释放 | 使用 new 或 malloc 分配的变量   | 用于在运行时需要灵活分配内存的场景           |
| 自动 automatic  | 定义时离开作用域  | 函数内的普通局部变量             | 用于临时计算或局部操作，效率高                |
| 线程 thread_local | 线程启动到线程结束 | `thread_local` 修饰的变量       | 用于线程独立的变量存储，避免多线程冲突   |

参考：{{<link href="https://www.geeksforgeeks.org/c/memory-layout-of-c-program/" content="Memory Layout of C Programs">}}

---

> 作者: [UAreFree](https://github.com/UAreFree)  
> URL: http://localhost:1313/posts/cpp-static/  

